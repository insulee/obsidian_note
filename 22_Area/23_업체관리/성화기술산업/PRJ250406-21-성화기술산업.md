### 성화기술산업 전광판 구성 및 리셋 상황

- 전광판 구성과 데이터 전송 및 표출은 다음의 순서로 진행
	1. 성화터치패널: 패널내의 버튼으로 전광판, 경광등, 싸이렌 등을 제어
	2. 마이컴: RELAY로 컨트롤러의 전원을 ON/OFF하고, 설정 및 문구표출 관련 패킷 전송
	3. 다빛솔루션 컨트롤러: 전달받은 패킷을 LED 모듈에 표출
- 컨트롤러 리셋 상황
	- 성화터치패널에서 교통통제중 등 **문구표출버튼**을 눌러 좌/우측 화살표 이동효과 중
	- **꺼짐버튼**을 누르고 다시 **문구표출버튼**을 눌렀을 때 (최소 6회 이상 반복) 컨트롤러 초기화
### 마이컴 --(TX/RX)--> 컨트롤러 패킷
- 성화터치패널에서 **꺼짐버튼** 눌러 컨트롤러를 끈 상태에서
- **문구표출버튼** 눌렀을 때 좌측은 TX 패킷, 우측은 RX 패킷

![[as_성화_250403_3.png|600]]

</br>

### 원인 분석

컨트롤러가 리셋되는 정확한 시점을 파악하는 것이 중요하므로, 리셋 현상을 
- RELAY ON(문구표출버튼 눌렀을 때)과 
- RELAY OFF(꺼짐버튼 눌렀을 때)의 두 가지 상황으로 나누어 원인을 분석

#### (1) RELAY ON: 컨트롤러 전원 인가와 패킷 전송이 동시에 실행
- 마이컴과 컨트롤러간의 송수신패킷을 살펴보면, 전광판이 꺼진 상태에서 **문구표출버튼**을 눌렀을 때, 아래의 두 과정이 동시에 진행
	- 컨트롤러 전원 인가 후 시스템 초기화(System Initialize) 시작
	- 마이컴에서 컨트롤러로 설정 및 문구 표출 관련 패킷 전송 (밝기설정에서 문구전송까지)
- 그로 인해 마이컴이 컨트롤러로부터 `![005099]`에 대한 수신 완료 패킷을 받지 못하면, 동일한 명령 패킷을 중복 전송
	- 평균적으로 `![005099!]` 4회, `![0054 50!]` 2회 정도 중복 전송
- 컨트롤러가 시스템 초기화 이후 중복 전송된 패킷들을 플래시 메모리에 저장하는 과정에서, 초기 전원이 불안정하거나 순간적인 전압 강하 현상이 발생하면 컨트롤러가 리셋되는 것으로 추정됨
#### (2) RELAY OFF: 플래시 메모리에 쓰기 동작과 전원 차단이 겹침
- 전광판 컨트롤러의 펌웨어는 FreeRTOS 상에서 동작하여 여러 태스크들의 실행 시점이 스케줄링에 따라 결정되어, 그 실행 시점은 일정하지 않아 예측하기 어려움
- 꺼짐버튼을 누르는 시점과 플래시 쓰기 동작이 겹친다면, 즉 플래시 쓰기 적업 도중 전원이 차단되면 플래시 손상으로 인해 컨트롤러가 리셋되는 것으로 추측
- 현재 꺼짐버튼의 동작 방식은, 컴퓨터를 끌 때 OS에서 정상적인 시스템 종료 절차를 거치지 않고 컴퓨터의 전원 플러그를 갑자기 뽑는 것과 유사한 상황

### 해결책 제안

#### (1) RELAY ON
- 제안1: 컨트롤러 전원 인가와 패킷 전송간의 간격 설정
	1. 꺼짐상태에서 **문구표출버튼**을 눌렀을 때
	2. RELAY ON → 컨트롤러에 전원 인가 
	3. 일정 간격(500~1000ms)을 두고(또는 컨트롤러의 초기 부팅이 끝나고 `[0/1]` 메시지가 나오면)
	4. 컨트롤러로 설정 및 문구표출 관련 패킷 전송
- 제안2: **켜기버튼**을 만들어 RELAY ON(전원 인가) 제어 후 명령 패킷 전송
	1. 성화터치패널에 **켜기버튼**을 만들어 버튼을 누르면 RELAY ON → 컨트롤러에 전원 인가 
	2. 그리고 **문구표출버튼**을 누르면 설정 및 문구표출 관련 패킷 전송 (RELAY ON 명령 삭제)

#### (2) RELAY OFF
- 제안1: **꺼짐버튼**을 눌렀을 때 안정적인 종료 프로세스 설정
	1. **꺼짐버튼**을 눌렀을 때, 바로 RELAY OFF하지 않고
	2. 컨트롤러 화면 끄기 패킷 `![00210!]` 전송 
	3. 수신패킷 `![00210!]`을 받고 RELAY OFF
-  제안2: RTC 검색 과정을 제거하고, 플래시 기록 방식이 변경된 **펌웨어 적용**
	- 컨트롤러 초기 부팅중 RTC를 검색하는 프로세스를 제거해 부팅 완료 시간 단축
	- 플래시에 쓰기와 전원 차단이 겹쳐 플래시가 손상되는 상황을 막기 위해 밝기제어, 표출속도 등의 패킷을 플래시에 저장하는 대신 RAM에 저장하는 방식으로 수정
		- 밝기 제어
		    - 전송 패킷 :
		        - 플래시에 저장: `![005099!]`
		        - RAM에 저장: `![0050991!]` (기존 패킷 마지막에 1을 추가)
		    - 응답 패킷 :
		        - `![00500!]`: 전송성공 (플래시, RAM 동일)
		        - `![0050F!]`: 전송실패 (플래시, RAM 동일)
		- 표출 속도 
		    - 전송 패킷 :
		        - 플래시에 저장: `![0054 50!]`
		        - RAM에 저장: `![0054 501!]` (기존 패킷 마지막에 1을 추가)
		    - 응답 패킷 :
		        - `![00540!]`: 전송성공 (플래시, RAM 동일)
		        - `![0054F!]`: 전송실패 (플래시, RAM 동일)
	- 수정 펌웨어
		- `DIBD500S_08C_02R020C_V3.1.4(BL V8.0)-UM-NoRTC.bin`
		- `DIBD600T_08C_04R020C_V3.1.4(BL V8.0)-UM-NoRTC.bin`