---
share_link: https://share.note.sx/pwxf148c#Z0+xoEIIhZEuf3o6sIETS6jJjkJQN1BfNPYxPm2yGhY
share_updated: 2025-01-14T15:40:29+09:00
---

이 문서는 전광판의 **제어** 및 **상태 관리를 위한 JSON 기반 프로토콜**을 정의합니다. 전광판의 상태 모니터링, 메시지 표시, 구성 설정 등 다양한 기능을 명시하여, **서버**와 **전광판** 간 통신을 효율적으로 수행할 수 있도록 합니다.

---

## **1. 프로토콜 개요**

- **관리 및 제어 대상**
    - 전광판의 작동 상태, 밝기, 시간, 전원, 화면 모듈 구성 등
- **주요 목적**
    - 전광판 상태 모니터링과 메시지 변경을 **표준화된 JSON**을 통해 처리
- **MQTT 환경**
    - QoS, Retain, Clean Session 등 MQTT 속성은 아래 항목에서 별도 정의

---

## **2. 전체 JSON 구조**

전광판을 관리하는 최상위 키는 `"2"`(전광판 정보)며, 그 하위에 전광판 식별자(예: `"RTE058"`)가 배치됩니다.

```json
{
  "2": {                  // 전광판 정보
    "RTE058": {           // 전광판 식별자 (예: RTE058)
      "1": [ ... ],       // 상태 요약
      "2": { ... },       // 전광판 상태 정보
      "3": { ... },       // 전광판 구성 설정
      "4": { ... },       // 이미지 파일 전송
      "5": [ ... ],       // 이미지 스케줄 관리
    }
  }
}
```

아래는 각 섹션에 대한 상세 설명입니다.

---

### **2.1. 상태 요약 (`"1"`)**

```json
"1": [
  1727403729, // 메시지 전송 시간 (UNIX 밀리초)
  0,          // 현재 상태: 0=대기, 1=작동중, 98=경고, 99=에러
  1727403729, // 이벤트 발생 시간 (UNIX 밀리초)
  1727403729  // 데이터 갱신 시간 (UNIX 밀리초)
]
```
- **메시지 전송 시간**: 이 프로토콜 데이터를 **언제**(어떤 시점)에 **전송**했는지 파악.
- **현재 상태**: 전광판이 지금 정상/경고/에러 중 어느 상태인지 한눈에 확인.
- **이벤트 발생 시간**: 장애·알림 등 **특정 이벤트**가 언제 일어났는지 추적.
- **데이터 갱신 시간**: 현재 표시 중인 메시지/상태가 언제 **최종 업데이트**되었는지 확인.

---

### **2.2. 전광판 상태 정보 (`"2"`)**

```json
"2": {
  "1": 1727403729,           // 전광판 시간 정보 (UNIX 밀리초)
  "2": 50,                   // 전광판 밝기 정보 (%)
  "3": [6, 2, 0, 0],         // 전광판 설정 정보
  "4": ["ascii.fnt", "unicode.fnt"], // 사용 중인 폰트 파일 목록
  "5": ["1.0.0", 1000]       // 펌웨어 버전, CPU 속도
}
```

| 키     | 예시값                  | 설명                                               |
| ----- | -------------------- | ------------------------------------------------ |
| `"1"` | `1727403729`         | 전광판 시간 (UNIX 밀리초)                                |
| `"2"` | `50`                 | 전광판 밝기 설정 (`0`: 최소 ~ `100`: 최대, %)               |
| `"3"` | `[6, 2, 0, 0]`       | 전광판 설정 정보<br>: `[가로 모듈 수, 세로 모듈 수, 단면 여부, 배열방식]` |
| `"4"` | `["ascii.fnt", ...]` | 사용 중인 폰트 파일 목록                                   |
| `"5"` | `["1.0.0", 1000]`    | `[펌웨어 버전, CPU 속도(MHz)]`                          |
- `"3"`:  전광판 설정 정보
	- 형태: `[가로모듈 수, 세로모듈 수, 단면 여부, 배열방식]`
	- 가로 모듈 수
		- 가로모듈전체 픽셀에서 16을 나눈 값
		- 예: `6`(가로모듈픽셀 개수가 96개)
	- 세로 모듈 수
		- 세로모듈전체 픽셀에서 16을 나눈 값
		- 예: `2`(세로모듈픽셀 개수가 32개)
	- 단면 여부
		- `0`: 단면
		- `1`: 양면
	- 배열방식
		- `0`: 가로형기본
		- `1`: 1줄 세로형
		- `2`: 2줄 세로형
		- `3`: 양면 가로형
		- 배열방식에 관한 내용은 [DABITDOCS](https://publish.obsidian.md/dabitdocs/2.+%EC%82%AC%EC%9A%A9%EC%9E%90+%EB%A7%A4%EB%89%B4%EC%96%BC/2.6.+LED+%EB%AA%A8%EB%93%88/2.6.2.+LED+%EB%AA%A8%EB%93%88+%EB%B0%B0%EC%97%B4%EB%B0%A9%EB%B2%95) 참고
	- 예: `[6, 2, 0, 0]` (가로 모듈 6, 세로 모듈 2, 단면, 가로형기본)
---

### **2.3. 전광판 구성 설정 (`"3"`)**

```json
"3": {
  "1": 1727403729,       // 전광판 시간 동기화 (UNIX 밀리초)
  "2": 50,               // 전광판 밝기 설정 (%)
  "3": [6, 2, 0, 0],     // 전광판 설정 정보
  "4": 1,                // 전광판 전원 설정
}
```

| 키     | 예시값            | 설명                                                                 |
| ----- | -------------- | ------------------------------------------------------------------ |
| `"1"` | `1727403729`   | 전광판 시간 동기화 (UNIX 밀리초)                                              |
| `"2"` | `50`           | 전광판 밝기 설정 (`0`: 최소 ~ `100`: 최대)                                           |
| `"3"` | `[6, 2, 0, 0]` | 전광판 설정 정보(전광판 상태 정보(`"2"`)와 동일)<br>: `[가로 모듈, 세로 모듈, 단면 여부, 배열방식]` |
| `"4"` | `1`            | 전광판 전원 설정 (`0`: 끄기, `1`: 켜기)                                        |


---

### **2.4. 이미지 파일 전송 (`"4"`)**

```json
"4": {
	"1": "start",          // 이미지 파일 전송 상태
	"2": {
		"1": "example_image.bmp",      // 이미지 파일명
		"2": "bmp",                   // 파일 유형
		"3": 123456,                  // 파일 전체 크기
		"4": 1500,                   // 각 청크의 크기
		"5": 83                   	 // 전송될 전체 청크 개수
		},
	"3": {
		"1": 1,                          // 전송 중인 청크의 인덱스 번호
		"2": 83                          // 전송될 전체 청크 개수
		},
	"4": "Base64_encoded_chunk_data",  // Base64로 인코딩된 이미지 데이터
	"5": "success",                       // 작업완료 상태
	"6": 0,                                 // 상태코드
	"7": "Upload completed successfully" // 설명 메시지
}
```

| 키(2.RTE058.4.X) | 예시값                               | 설명                                                                                               |
| --------------- | --------------------------------- | ------------------------------------------------------------------------------------------------ |
| `"1"`           | `"start"`                         | 이미지 파일 전송 상태<br>- `"start"`: 전송 요청<br>- `"data"`: 전송 중<br>- `"end"`: 전송 완료<br>- `"response"`: 응답 |
| `"2"`           | -                                 | 이미지 정보                                                                                           |
| `"2.1"`         | `"example_image.bmp"`             | 이미지 파일명 (최대 70바이트)                                                                               |
| `"2.2"`         | `"bmp"`                           | 이미지 파일 유형 (bmp, jpg, gif 등)                                                                      |
| `"2.3"`         | `123456`                          | 이미지 파일 전체 크기 (바이트)                                                                               |
| `"2.4"`         | `1500`                            | 각 청크의 크기 (바이트)                                                                                   |
| `"2.5"`         | `83`                              | 전송될 전체 청크 개수                                                                                     |
| "3"             | -                                 | 청크 정보                                                                                            |
| `"3.1"`         | `1`                               | 전송 중인 청크의 인덱스 번호                                                                                 |
| `"3.2"`         | `83`                              | 전송될 전체 청크 개수                                                                                     |
| `"4"`           | `"Base64EncodedData"`             | Base64로 인코딩된 이미지 데이터 (BMP/JPG)<br> 1500바이트 이하로 전송가능                                              |
| `"5"`           | `"success"`                       | 작업완료 상태 <br>- `"success"`: 성공<br>- `"error"`: 실패                                                 |
| `"6"`           | `0`                               | 상태코드                                                                                             |
| `"7"`           | `"Upload completed successfully"` | 설명 메시지                                                                                           |


---

### **2.5. 이미지 스케줄 관리 (`"5"`)**


```json
"__5": "이미지 스케줄 관리"
"5": {
	"1": "set",                        // 스케줄 등록 상태(set, get)
	"2": [                             // 이미지 스케줄 목록
        {
          "1": "12345",              // 이미지 ID
          "2": "example_image.bmp",  // 이미지 파일명
          "3": "move_left",              // 이미지 효과
          "4": {                   // 이미지 효과 속성
			"1": 500,                       // 반복 간격(ms)
            "2": 1000,                      // 유지 시간(ms)
            "3": 20,                       // 이미지 효과 속도(0~99), 높은 값일수록 빠르게 표시
            "4": 1000                      // 이미지 효과 지연 시간(ms)
          },
          "5": {
            "start": "2025-01-15T08:00:00Z",
            "end": "2025-01-15T20:00:00Z"
		    }
        }
    ]
}

```

| 키<br>(2.RTE058.5.X) | 예시값                               | 설명                                                                                                                                                        |
| ------------------- | --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `"1"`               | `"set"`                           | 이미지 파일 스케줄 등록 및 조회<br>- `"set"`: 스케줄 등록<br>- `"get`:  스케줄 조회<br>- `"get_response"`: 스케줄 조회 응답<br>- `"delete"`: 스케줄 삭제<br>- `"delete_response"`: 스케줄 삭제 응답 |
| `"2"`               |                                   | 이미지 파일 스케줄 목록                                                                                                                                             |
| `"2.1"`             | `"12345"`                         | 이미지 ID                                                                                                                                                    |
| `"2.2"`             | `"example_image.bmp"`             | 이미지 파일명 (최대 70바이트)                                                                                                                                        |
| `"2.3"`             | `"move_left"`                     | 이미지 효과                                                                                                                                                    |
| `"2.4"`             |                                   | 이미지 효과 속성                                                                                                                                                 |
| `"2.4.1"`           | `500`                             | 반복 간격 (ms)                                                                                                                                                |
| `"2.4.2"`           | `1000`                            | 유지 시간 (ms)                                                                                                                                                |
| `"2.4.3"`           | `20`                              | 이미지 효과 속도(0~99), 높은 값일수록 빠르게 표시                                                                                                                           |
| `"2.4.4"`           | `1000`                            | 이미지 효과 지연 시간 (ms)                                                                                                                                         |
| `"2.5"`             |                                   | 스케줄 시간                                                                                                                                                    |
| `"2.5.1"`           | `"2025-01-15T08:00:00Z"`          | 스케줄 시작 시간                                                                                                                                                 |
| `"2.5.2"`           | `"2025-01-15T20:00:00Z"`          | 스게줄 종료 시간                                                                                                                                                 |
| `"5"`               | `"success"`                       | 작업완료 상태 <br>- `"success"`: 성공<br>- `"error"`: 실패                                                                                                          |
| `"6"`               | `0`                               | 상태코드                                                                                                                                                      |
| `"7"`               | `"Upload completed successfully"` | 설명 메시지                                                                                                                                                    |
| `"8"`               | `1`                               | 스케줄 삭제 여부(0=삭제안함, 1=삭제 )                                                                                                                                  |
| `"9"`               | -                                 | 스케줄 삭제                                                                                                                                                    |
| `"9.1"`             | ["12345"]                         | 삭제할 이미지 ID 목록                                                                                                                                             |
| `"9.2"`             | `"success"`                       | 작업완료 상태 <br>- `"success"`: 성공<br>- `"error"`: 실패                                                                                                          |
| `"9.3"`             | `"Image deleted successfully"`    | 설명 메시지                                                                                                                                                    |

- **이미지 효과**: `flash`, `move_left`, `blinking`, `stop` 등 다양한 효과 정의 가능
- **이미지 효과 속성**: 효과별 파라미터(속도, 간격, 유지 시간 등)


---

## **3. MQTT 설정**

### **3.1 QoS (Quality of Service)**

- **전광판 클라이언트는 QoS `0`으로 설정**
    - `0`: At most once (확인 응답 없이 최대 1회 전송)
    - `1`: At least once (메시지 유실 없도록 최소 1회 전달 & 확인)
    - `2`: Exactly once (중복 없이 정확히 1회 전달)

### **3.2 패킷 분할**

- **1500바이트 이하**로 메시지를 분할 전송 권장 (이미지 전송 시 Base64 인코딩 등)
- 대용량 데이터(이미지, 스케줄 파일 등)는 여러 패킷으로 나누어 **수신 완료** 후 `"updated"` 상태로 전환

### **3.3 Retain 설정**

- **`false` 사용** (메시지를 브로커에 저장하지 않음)
    - `true`: 브로커가 마지막 메시지를 저장, 새 구독자 연결 시 즉시 전달
    - `false`: 기존 메시지를 저장하지 않음. 구독 중인 클라이언트만 수신

### **3.4 Clean Session**

- **`false` 사용** (기존 세션 및 구독 정보, 메시지 큐 유지)
    - 오프라인 중 발행된 QoS1/2 메시지를 재수신 가능
    - 전광판이 자주 오프라인되는 환경에서 유용

---

## **4. 최종 예시 JSON (주석 포함)**

아래는 하나의 전광판(`"RTE058"`)에 대한 모든 섹션을 기술한 예시입니다. 실제 운영 시에는 **필요한 부분만** 발행하거나, **대용량 파일**을 여러 메시지로 분할해서 전송합니다.  
주석(`"__<키>"`) 필드는 **사람이 읽기 쉽게** 하기 위한 설명 용도로 삽입했으며, 실제 파싱 환경에서는 제거되는 것이 일반적입니다.

```json
{
"__2": "전광판 정보",
"2": {
	"__RTE058": "전광판 식별자",
	"_RTE058": ["M", "JSONOBJECT", "R/O"],
	"RTE058": {
		"__1": ["상태 요약",
			"메시지 전송 시간", 
			"현재 상태(0=대기, 1=작동중, 98=경고, 99=에러)",
			"이벤트 발생 시간(UNIX 밀리초)",
			"데이터 갱신 시간(UNIX 밀리초)"
		],
		"_1": ["M", "ARRAY[TIMESTAMP.MS, UINT, TIMESTAMP.MS, TIMESTAMP.MS]", "R/O"],
		"1": [
			1727403729, 
			0,          
			1727403729, 
			1727403729  
		],
		
		"__2": "전광판 상태 정보",
		"_2": ["O", "JSONOBJECT", "R/O"],
		"2": {
			"__1": "전광판 시간 정보 (UNIX 밀리초)",
			"_1":["O", "LONG", "R/O"],
			"1": 1727403729,
		
			"__2": "전광판 밝기 정보(%)",
			"_2":["O", "INT", "R/O"],
			"2": 50,
			
			"__3": ["전광판 설정 정보",
				"가로모듈 수(column, 16픽셀이 1열의 기준)",
				"세로모듈 수(row, 16픽셀이 1단의 기준)",
				"단면 여부(0=단면, 1=양면)",
				"배열방식(0=가로형 기본, 1=1줄 세로형, 2=2줄 세로형, 3=양면 가로형)"
			],
			"_3":["O", "ARRAY(INT)", "R/O"],
			"3": [6, 2, 0, 0],
		
			"__4": "사용 중인 폰트 파일 목록",
			"_4":["O", "ARRAY(STRING)", "R/O"],
			"4": ["ascii.fnt", "unicode.fnt"],
		
			"__5": ["펌웨어 버전",
				"CPU속도(MHz)"
			],
			"_5":["O", "ARRAY(STRING, INT)", "R/O"],
			"5": ["1.0.0", 1000]
		},
		
		"__3": "전광판 구성 설정",
		"_3":["O", "JSONOBJECT", "R/O"],
		"3": {
			"__1": "전광판 시간 동기화 (UNIX 밀리초)",
			"_1":["O", "LONG", "R/O"],  
			"1": 1727403729,
		
			"__2": "전광판 밝기 설정(%)",
			"_2":["O", "INT", "R/O"],
			"2": 50,
		
			"__3":["전광판 설정 정보",
				"가로모듈 수(column)",
				"세로모듈 수(row)",
				"단면 여부(0=단면, 1=양면)",
				"배열방식(0=가로형 기본, 1=1줄 세로형, 2=2줄 세로형, 3=양면 가로형)"
			],
			"_3":["O", "ARRAY(INT)", "R/O"],
			"3": [6, 2, 0, 0],
		
			"__4": "전광판 전원 설정(0=끄기, 1=켜기)",
			"_4":["O", "INT", "R/O"],
			"4": 1
		},
		
		"__4": "이미지 파일 전송",
		"_4":["M", "JSONOBJECT", "R/O"],
		"4": {
			"__1": "이미지 파일 전송 상태(start=전송요청, data=전송중, end=전송완료)",
			"_1":["M", "STRING", "R/O"],
			"1": "start",
		
			"__2": "이미지 정보",
			"_2":["M", "JSONOBJECT", "R/O"],
			"2": {
				"__1" : "이미지 파일명",
				"_1":["M", "STRING", "R/O"],
				"1": "flashing.bmp",

				"__2" : "파일 유형",
				"_2":["M", "STRING", "R/O"],
				"2": "bmp",

				"__3" : "파일 전체 크기",
				"_3":["M", "INT", "R/O"],
				"3": 123456,

				"__4" : "각 청크의 크기",
				"_4":["M", "INT", "R/O"],
				"4": 1500,

				"__5" : "전송될 전체 청크 개수",
				"_5":["M", "INT", "R/O"],
				"5": 83
			}
		},


		"__5": "이미지 스케줄 관리",
		"_5":["M", "JSONOBJECT", "R/O"],
		"5": {
			"__1" : "이미지 스케줄 등록 및 조회",
			"_1":["M", "STRING", "R/O"],
			"1": "set",

			"__2" : "이미지 스케줄 목록",
			"_2":["M", "ARRAY(JSONOBJECT)", "R/O"],
			"2": [				
				{
					"__1" : "이미지 ID",
					"_1":["M", "STRING", "R/W"],
					"1": "12345",
					
					"__2" : "이미지 파일명",
					"_2":["M", "STRING", "R/W"],
					"2": "example_image.bmp", 

					"__3" : "이미지 효과",
					"_3":["M", "STRING", "R/W"],
					"3": "move_left",
					
					"__4" : "이미지 효과 속성",
					"_4":["O", "JSONOBJECT", "R/O"],
					"4": {
						"__1": "반복 간격(ms)",
						"_1":["O", "INT", "R/W"],
						"1": 500,
						
						"__2": "유지 시간(ms)",
						"_2":["O", "INT", "R/W"],
						"2": 5000,
						
						"__3": "이미지 효과 속도(0~99), 높은 값일수록 빠르게 표시",
						"_3":["O", "INT", "R/W"],
						"3": 50,
						
						"__4": "이미지 효과 지연 시간(ms)",
						"_4":["O", "INT", "R/W"],
						"4": 1000
					} 
				}
			]
		}
	}
}
}

```

---

## 부록1. `"1"` 섹션의 각 항목 용도

```json
"1": [
  1727403729, // 메시지 전송 시간 (UNIX 밀리초)
  0,          // 현재 상태: 0=대기, 1=작동중, 98=경고, 99=에러
  1727403729, // 이벤트 발생 시간 (UNIX 밀리초)
  1727403729  // 데이터 갱신 시간 (UNIX 밀리초)
]
```

1. **메시지 전송 시간** (UNIX 밀리초)
    - **의도**: 프로토콜 데이터를 **언제**(어떤 시점)에 **전송**했는지.
    - **이유**: 서버가 “이 메시지가 발행된 지 얼마나 됐나?” 등 시간차를 확인 가능.
2. **현재 상태** (`0`=대기, `1`=작동중, `98`=경고, `99`=에러)
    - **의도**: 전광판이 지금 정상인지, 경고·에러 상태인지 **즉각 파악**하기 위함.
    - **이유**: 서버/관리자가 전광판 이상 상태를 **빠르게 알 수 있어야** 유지보수 가능.
3. **이벤트 발생 시간** (UNIX 밀리초)
    - **의도**: 특정 이벤트(에러·알림·설정 변경 등)가 **언제** 일어났는지 기록.
    - **이유**: 전광판 상태나 이벤트를 **시간 순서**대로 관리하고, 다른 장비와의 로그를 동기화.
4. **데이터 갱신 시간** (UNIX 밀리초)
    - **의도**: 전광판 내부 데이터(상태·메시지·설정)가 **마지막으로 언제 업데이트**되었는지 추적.
    - **이유**: 서버에서 **오래된 데이터**임을 감지하거나, 새로운 데이터 전송 시점 판단에 활용.

## 부록2. MQTT 수신 오류 코드 정의

MQTT 프로토콜을 통해 전광판(디바이스)와 통신할 때, **수신(JSON) 파싱**이나 **로직 검증** 과정에서 발생할 수 있는 대표적인 오류 코드를 정리합니다. 각 오류 코드는 다음과 같이 #define 매크로로 선언하여 사용하며, 시스템에 맞춰 **RESULT_CODE**나 내부 처리 결과로 반환할 수 있습니다.

```c
#define MQTT_RX_SUCCESS                 0   // 정상 처리
#define MQTT_RX_FAIL                    1   // 일반 실패(세부 원인 불명)
#define MQTT_RX_ERR_JSON_PARSE         -1   // JSON 파싱 오류
#define MQTT_RX_ERR_VER_MISMATCH       -2   // 지원하지 않는 MSG_VER
#define MQTT_RX_ERR_FIELD_MISMATCH     -3   // 필수 키 누락 (MSG_TYPE, MSG_ID 등)
#define MQTT_RX_ERR_MOID_MISMATCH      -4   // MOID 구조 및 자료형 오류
#define MQTT_RX_ERR_PARAM_RANGE        -5   // 파라미터 값 범위 초과 / 유효성 검증 실패
#define MQTT_ERR_DEVICE_MISMATCH       -6   // RS232 장치 수신 오류(수신 메시지 없음, 메시지 형식 오류 등)
#define MQTT_RX_ERR_INTERNAL_ERROR     -7   // 내부 처리 에러(미분류)
```

### 에러 코드 요약

|코드|정의 상수|의미|
|:-:|:--|:--|
|0|`MQTT_RX_SUCCESS`|정상 처리 (오류 없음)|
|1|`MQTT_RX_FAIL`|일반 실패 (세부 원인 불명)|
|-1|`MQTT_RX_ERR_JSON_PARSE`|수신된 JSON 문법/구조가 잘못되었거나 파싱 실패|
|-2|`MQTT_RX_ERR_VER_MISMATCH`|메시지 버전(`MSG_VER`)이 지원되지 않음|
|-3|`MQTT_RX_ERR_FIELD_MISMATCH`|필수 필드(예: `MSG_TYPE`, `MSG_ID`)가 누락되었거나 타입 불일치|
|-4|`MQTT_RX_ERR_MOID_MISMATCH`|`MOID` 구조가 잘못되었거나, 자료형이 기대와 다름|
|-5|`MQTT_RX_ERR_PARAM_RANGE`|매개변수 값이 범위를 초과하거나 유효성 검증에 실패 (예: 밝기=200 등)|
|-6|`MQTT_ERR_DEVICE_MISMATCH`|RS232 등 하위 장치 간 수신 오류 (메시지 누락, 형식 불일치 등)|
|-7|`MQTT_RX_ERR_INTERNAL_ERROR`|그 외 내부 처리 에러(미분류). 로직상 예외 케이스 등을 포괄적으로 처리|
